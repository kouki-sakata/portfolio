<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.teamdev.mapper.StampHistoryMapper">
    <!--対象年月、対象従業員IDの打刻記録情報を取得する-->
    <!--対象年月の日数分行を取得したいので、MySQLのSQL文でカレンダーテーブル（generated_dates）を作成し、右外部結合する-->
    <select id="getStampHistoryByYearMonthEmployeeId" parameterType="map"
            resultType="com.example.teamdev.entity.StampHistoryDisplay">
        SELECT
            sh.id AS id,
            to_char(gd.date, 'YYYY') AS year,
            to_char(gd.date, 'MM') AS month,
            to_char(gd.date, 'DD') AS day,
            CASE EXTRACT(DOW FROM gd.date)
                WHEN 0 THEN '日'
                WHEN 1 THEN '月'
                WHEN 2 THEN '火'
                WHEN 3 THEN '水'
                WHEN 4 THEN '木'
                WHEN 5 THEN '金'
                WHEN 6 THEN '土'
            END AS day_of_week,
            #{employeeId} AS employee_id,
            concat_ws(' ', COALESCE(emp.first_name, ''), COALESCE(emp.last_name, '')) AS employee_name,
            concat_ws(' ', COALESCE(emp2.first_name, ''), COALESCE(emp2.last_name, '')) AS update_employee_name,
            to_char(sh.in_time, 'HH24:MI') AS in_time,
            to_char(sh.out_time, 'HH24:MI') AS out_time,
            to_char(sh.update_date, 'YYYY/MM/DD HH24:MI') AS update_date
        FROM (
            <foreach collection="datesInMonth" item="date" separator=" UNION ALL ">
                SELECT CAST(#{date} AS DATE) AS date
            </foreach>
        ) AS gd
        LEFT JOIN stamp_history sh ON
            to_char(gd.date, 'YYYY') = sh.year AND
            to_char(gd.date, 'MM') = sh.month AND
            to_char(gd.date, 'DD') = sh.day AND
            sh.employee_id = #{employeeId}
        LEFT JOIN employee emp ON emp.id = #{employeeId}
        LEFT JOIN employee emp2 ON sh.update_employee_id = emp2.id
        ORDER BY gd.date ASC
    </select>

    <!-- データを挿入または更新する -->
    <!--①saveStampHistory→saveに修正②ON DUPLICATE KEY UPDATEの重複のキー削除-->
    <!--③IFNULL関数追記-->
    <insert id="save" parameterType="com.example.teamdev.entity.StampHistory">
        INSERT INTO stamp_history (
            id, year, month, day, employee_id, in_time, out_time,
            update_employee_id, update_date
        ) VALUES (
            DEFAULT, #{year}, #{month}, #{day}, #{employeeId}, #{inTime}, #{outTime},
            #{updateEmployeeId}, #{updateDate}
        )
    </insert>
    <!--更新の追記-->
    <update id="update" parameterType="com.example.teamdev.entity.StampHistory">
        UPDATE stamp_history
        SET
        year = #{year},
        month = #{month},
        day = #{day},
        in_time = #{inTime},
        out_time = #{outTime},
        update_employee_id = #{updateEmployeeId},
        update_date = #{updateDate}
        WHERE id = #{id}
    </update>
</mapper>
