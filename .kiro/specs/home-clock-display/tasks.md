# Implementation Plan

- [x] 1. 現在時刻表示の土台を整える
  - リアルタイム表示の信頼性と再利用性を高めるため、時計ロジックをUIから独立させる
  - 表示形式とISO文字列の両方を提供できる状態を用意する
  - _Requirements: R1.1, R1.2, R1.3, R3.1_

- [x] 1.1 JST表示フォーマットのユーティリティを整備する
  - 既存のタイムスタンプ生成ロジックを再利用し、UI表示向けに日付・曜日・時刻を結合する整形処理を追加する
  - 期待されるフォーマットとエラーハンドリングを明確にするため、境界ケースのテストデータを設計する
  - _Requirements: R1.1_

- [x] 1.2 リアルタイム更新フックを構築する
  - JST固定で1秒ごとに最新時刻を取得し、表示用テキストとISO文字列をセットで提供する状態管理を実装する
  - 非同期初期化や例外発生時にフォールバックできる分岐と復旧シナリオを組み込み、更新ループの健全性を保つ
  - _Requirements: R1.2, R1.3, R3.1, R3.2_

- [x] 2. ホームダッシュボードに時計体験を組み込む
  - ユーザーが画面遷移直後から常時時刻を確認できるよう、UIへの表示導線を整備する
  - ローディング・エラー時も時計体験が継続するよう、状態ごとの描画を見直す
  - _Requirements: R1.1, R1.3_

- [x] 2.1 時計表示コンポーネントを実装する
  - 通常表示とフォールバック表示の双方を提供し、アクセシビリティの配慮（例: aria-live）も反映する
  - 画面内の複数レイアウト（ヒーロー、カード）に適応できるデザインプロップを設計する
  - _Requirements: R1.1, R3.1_

- [x] 2.2 ホーム画面の各状態へ時計を統合する
  - 通常時のヒーローセクションと打刻カードに時計を追加し、秒単位更新を反映させる
  - ローディング時とエラー時にも時計が自律して描画されるよう、既存の条件分岐とスケルトンを調整する
  - _Requirements: R1.1, R1.3_

- [x] 3. 打刻処理と時計表示を同期させる
  - 表示中の時刻で打刻APIを呼び出し、レスポンスが返るまで値を固定する流れを構築する
  - 成功・失敗時のメッセージに送信時刻を添えて利用者へフィードバックする
  - _Requirements: R2.1, R2.2, R2.3, R2.4_

- [x] 3.1 打刻ロジックにタイムスタンプ供給ポイントを追加する
  - 打刻開始時に時計フックから取得したISO文字列を渡し、レスポンス完了まで保持する仕組みを導入する
  - 成功・競合・失敗の結果ステータスに送信時刻を含め、メッセージと紐づけて扱えるよう構造化する
  - _Requirements: R2.1, R2.2, R2.3_

- [x] 3.2 打刻UIで同期結果を可視化する
  - ボタン押下時に取得した時刻を打刻カードへ伝播し、成功メッセージとともに表示する
  - 失敗時には直近の時計表示を維持しつつ、次回リトライで最新値を取得する導線を案内する
  - _Requirements: R2.3, R2.4_

- [ ] 4. フォールバックと回復シナリオを強化する
  - 時計ロジックが例外を検知した場合も打刻が継続できるようメッセージと再試行手段を備える
  - キャッシュ無効化や再レンダー後も更新ループが復帰することを検証し、必要なクリーンアップを実装する
  - _Requirements: R2.4, R3.1, R3.2, R3.3_

- [ ] 4.1 フォールバック表示と復旧トリガーを実装する
  - 時計エラー時に代替テキストを提示し、利用者へ端末確認を促すメッセージを整備する
  - 復旧判定と再開処理を設け、外部要因から回復した際に自動でリアルタイム表示へ戻す
  - _Requirements: R3.1, R3.2_

- [ ] 4.2 キャッシュ無効化後の安定動作を保証する
  - 打刻完了後のキャッシュリセットや再描画が実行されても、時計更新ループが継続することを確認する
  - 必要に応じてリフレッシュ処理やステート初期化を見直し、再レンダー時のリークや停止を防ぐ
  - _Requirements: R2.4, R3.3_

- [ ] 5. 品質保証を完了する
  - 時刻表示・打刻同期・フォールバックの各シナリオを自動化テストでカバーし、回 regressions を防ぐ
  - UIとロジックの境界を越えた統合動作を検証し、ユーザー体験の信頼性を担保する
  - _Requirements: R1.1, R1.2, R1.3, R2.1, R2.2, R2.3, R2.4, R3.1, R3.2, R3.3_

- [ ] 5.1 ユニットテストとフック検証を追加する
  - 時計フォーマットユーティリティと更新フックの通常系・異常系をテストし、ミリ秒レベルの不安定さを排除する
  - 打刻ロジックの新しいステータス構造やタイムスタンプ保持を検証し、複数結果パターンの期待値を定義する
  - _Requirements: R1.1, R1.2, R2.1, R2.2, R2.3, R3.1_

- [ ] 5.2 コンポーネント統合テストを充実させる
  - 時計コンポーネントと打刻カードの組み合わせで、表示更新・成功メッセージ・フォールバックの流れを確認する
  - ホーム画面のローディング・エラー状態でも時計が表示され続けることをテストで保証する
  - _Requirements: R1.1, R1.3, R2.3, R2.4, R3.2_

- [ ] 5.3 E2Eシナリオでユーザーフローを検証する
  - ブラウザ環境で時計が秒単位に更新されることを確認し、打刻成功時に送信時刻が表示される流れを自動化する
  - フォールバックメッセージの表示条件と復旧後の自動切り替えをE2Eテストで確認し、実利用に近いリグレッションを防止する
  - _Requirements: R1.2, R2.3, R3.1, R3.2_
