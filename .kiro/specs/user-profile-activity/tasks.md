# Implementation Plan

- [ ] 1. フロントエンドUIを構築してプロフィール画面の土台を整える
- [ ] 1.1 プロフィールページの骨組みと概要表示を実装する
  - 認証済みユーザー向けにプロフィール画面シェルとルーティングを追加し、共通レイアウトに組み込む
  - 氏名・メール・社員番号・部署・住所・最終更新日時を表示するカードを配置し、取得中はスケルトンと未設定ラベルを切り替える
  - 画面全体のローディング・エンプティ状態を整理し、画面初期化時の重複リクエストを防ぐ
  - _Requirements: 1.1, 1.2, 1.3_
- [ ] 1.2 編集フォームと入力バリデーションを整備する
  - react-hook-form と zod スキーマで住所・部署・社員番号・活動メモの入力制約と禁止文字チェックを実装する
  - 送信中はボタンを無効化し、成功時は最新値を即時反映してトースト通知を表示する
  - 入力未設定時のデフォルト値とエラーメッセージを UI に統一表現で表示する
  - _Requirements: 2.1, 2.2, 2.3_
- [ ] 1.3 活動履歴テーブルUIを実装する
  - TanStack Table ベースで操作日時・実行者・操作種別の一覧を構築し、列ごとにソートを切り替えられるようにする
  - ページネーションUIとページ切り替えハンドリングを追加し、閾値超過時に段階的ロードを行う
  - 差分表示用の行展開やモーダルを用意し、変更フィールドと前後スナップショットのハイライトを表現する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 2. バックエンドAPIでプロフィール取得・更新を提供する
- [ ] 2.1 プロフィール取得APIを実装する
  - 自身・管理者向けの GET エンドポイントを追加し、employee 情報とメタデータを集約したレスポンスを返却する
  - 権限制御と存在チェックを組み込み、未権限アクセス時に適切なレスポンスを返す
  - DTO 変換で空値を正規化し、UI が未設定ラベルを判定できる形に整形する
  - _Requirements: 1.1, 1.2_
- [ ] 2.2 メタデータ更新APIを実装する
  - PATCH エンドポイントでプロフィール更新リクエストを受け付け、フィールド単位のバリデーションと楽観的ロックを実装する
  - 更新後は最新プロフィールを再取得して返し、重複更新や整合性違反をハンドリングする
  - バリデーション失敗時のメッセージとHTTPステータスを統一する
  - _Requirements: 2.1, 2.2, 2.4_
- [ ] 2.3 活動履歴APIを実装する
  - 活動履歴を返却するアプリケーション層の機能を通じてページング可能な一覧を提供し、フィルタ条件をクエリで受け取る
  - operation type・display name をプロフィール用に拡張し、構造化された差分 JSON をレスポンスに含める
  - 応答時間とレコード上限を考慮したデフォルトのページサイズとソート順を実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 3. 永続化層と監査ログを拡張する
- [ ] 3.1 プロフィール用JSONカラムと履歴詳細カラムのマイグレーションを適用する
  - `profile_metadata` と `log_history.detail` の JSONB カラムを追加し、既存行へデフォルト値を設定するマイグレーションを作成する
  - ロールバック手順とデプロイ順序を明確化し、マイグレーション適用後の整合性チェックを実施する
  - 開発・CI 環境でマイグレーションの前後互換性を検証し、必要な初期データ反映を準備する
  - _Requirements: 2.4, 3.4_
- [ ] 3.2 リポジトリとマッパーを更新する
  - プロフィールメタデータの読み書きを JSONB として扱うリポジトリを実装し、空 JSON を初期化する
  - プロフィール専用ログ挿入用のマッパーを追加し、既存の重複抑止ロジックから分離する
  - detail JSON のスキーマバージョン管理とエラーハンドリングを整備し、将来拡張に備える
  - _Requirements: 2.4, 3.1, 3.4_
- [ ] 3.3 監査サービスで差分記録を行う
  - プロフィール閲覧・更新イベントを登録するサービスを拡張し、changedFields・before/after スナップショットを detail JSON に格納する
  - ログ登録失敗時のフォールバックと通知レベルを定義し、監査ログの保全性を確保する
  - 監査ビューやログ検索機能と連携し、新しい display name / operation type を表示できることを確認する
  - _Requirements: 3.1, 3.3, 3.4_

- [ ] 4. フロントエンドとバックエンドを統合しUXを仕上げる
- [ ] 4.1 APIクライアントとReact Queryフックを整備する
  - Axios クライアントでプロフィール取得・更新・活動履歴取得のリクエストラッパーを実装する
  - React Query でキャッシュキーとプリフェッチ戦略を定義し、バックエンドレスポンスを UI モデルへ変換する
  - エラー時・未認証時の例外を統一ハンドラへ委譲し、ガードされた画面遷移と連携する
  - _Requirements: 1.1, 2.2, 3.1_
- [ ] 4.2 UIコンポーネントをデータと接続する
  - プロフィールカードと編集フォームにクエリ結果をバインドし、更新後の再検証と楽観的更新を設定する
  - 編集成功・失敗時のトースト通知、バリデーションエラー表示、ボタン状態制御を連携する
  - メタデータ未設定時の表示や自動フォーカスなど、アクセシビリティとUXの細部を整える
  - _Requirements: 1.1, 2.2, 2.3_
- [ ] 4.3 活動履歴テーブルに差分情報を表示する
  - 差分情報のフィールド一覧と前後スナップショットを UI へマッピングし、ハイライト表示を実装する
  - ページング・ソートのユーザー操作をバックエンドクエリへ反映し、ローディング・エンプティ状態を制御する
  - 期間フィルタや再読み込み操作を組み込み、フロントキャッシュと整合する再取得フローを整備する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 5. テストと検証を完了する
- [ ] 5.1 バックエンドの自動テストを追加する
  - プロフィール集約ロジック、メタデータ永続化処理、監査登録処理の単体テストで新しい分岐を検証する
  - UserProfileRestController の統合テストで権限・バリデーション・差分レスポンスを確認する
  - Flyway マイグレーションの適用可否をテスト環境で検証し、detail JSON のシリアライズを確認する
  - _Requirements: 1.1, 2.1, 2.4, 3.1_
- [ ] 5.2 フロントエンドの自動テストを追加する
  - ViewModel とフォームバリデーションの単体テストで未設定表示とエラー提示を確認する
  - プロフィール画面の統合テストで更新フローと活動履歴ページングを MSW モック経由で検証する
  - 差分ハイライトやローディング状態のスナップショットテストでUI変化を固定化する
  - _Requirements: 1.1, 2.2, 3.2_
- [ ] 5.3 E2Eシナリオでエンドツーエンド動作を確認する
  - Playwright テストでプロフィール閲覧・編集・活動履歴確認の主要シナリオを実行し、差分表示とトースト通知を検証する
  - 本番相当データで JSONB 永続化と監査ログ反映を確認し、再テスト時のデータリセット手順を整える
  - テスト結果をレビューし、失敗時のログ収集とリトライ方針をドキュメント化する
  - _Requirements: 1.1, 2.2, 3.1_
