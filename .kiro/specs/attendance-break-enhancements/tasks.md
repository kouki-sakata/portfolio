# Implementation Plan

- [ ] 1. 休憩・残業データを保持するバックエンド基盤を整備
  - 日次の休憩情報と残業量を永続化・取得できる下支えを揃える
  - 既存の勤怠サービスと新しい計算ロジックの責務境界を見直して統合する
  - 新スナップショット設計を反映したテスト観点を洗い出し後続タスクに共有する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4_

- [ ] 1.1 休憩・残業カラムの追加と永続層の更新
  - 休憩開始・休憩終了・残業分数を扱えるようにスキーマとマイグレーションを拡張する
  - MyBatisの取得・保存クエリを新カラムに対応させUTC→JST変換ルールを整理する
  - 初期データをNULL扱いにしてUIが「未登録」を選択的に表示できるよう挙動を確認する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2, 3.3, 3.4_

- [ ] 1.2 日次勤怠スナップショットサービスと残業計算を構築
  - 当日の出勤・休憩・退勤状況からステータス列挙値を導出するビジネスロジックを実装する
  - シフト情報を取り込み残業分数を算出する共通計算ユーティリティを整備する
  - 取得できなかった値に対するNULLハンドリングとフォールバックログを確立する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ] 2. 拡張APIでホームと履歴に休憩・ステータス情報を提供する
  - ホーム概要APIへ日次スナップショットを組み込みレスポンス契約を更新する
  - 勤怠履歴APIを休憩時刻と残業値に対応させて一覧・集計の整合性を取る
  - 休憩トグルAPIの振る舞いを新データモデルと突き合わせて矛盾を防ぐ
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4_

- [ ] 2.1 ホーム概要APIのレスポンス拡張
  - 日次スナップショットを取得してattendanceブロックに整形しレスポンスへ組み込む
  - ステータスごとのHTTPステータス・エラーハンドリングが既存ガイドラインに沿うことを確認する
  - タイムゾーン変換とフォーマットをクライアント要件のHH:mm表示と揃える
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ] 2.2 勤怠履歴APIの休憩・残業フィールド拡張
  - 一覧レスポンスに休憩開始・終了・残業分数を追加し既存のページネーションと整合させる
  - 残業分数が0以下の場合のフォーマットとバリデーションルールを明示する
  - 月次統計計算と新フィールドの連携を確認し差分検証を自動化する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 2.3 休憩トグルAPIの状態遷移と整合性を保証
  - 現在の休憩状態に応じて開始・終了を切り替えるトグルロジックを実装する
  - 二重操作や不整合を409などの業務エラーで返す分岐と監査ログを追加する
  - トグル後に日次スナップショットと履歴レスポンスの不整合が残らないよう再取得を行う
  - _Requirements: 1.3, 1.4, 2.2, 2.3, 2.4_

- [ ] 3. ホームダッシュボードで休憩時刻と勤務ステータスを表示する
  - React Queryの取得ロジックを拡張しattendance情報をキャッシュへ統合する
  - ステータスバッジと時刻表示をデザインガイドラインに従って追加する
  - 休憩操作のトリガーと表示更新を一貫させ利用者のフィードバックを最適化する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ] 3.1 ダッシュボード取得ロジックをattendance情報に対応
  - クエリキーとキャッシュ更新方針を休憩トグルと打刻処理と共有できるよう再設計する
  - attendanceがnullの場合のフォールバック表示と読み込み状態を整理する
  - 型安全なスキーマ検証でAPI拡張後のフィールドを取りこぼさないようにする
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1_

- [ ] 3.2 休憩時刻と勤務ステータスのUI表示を追加
  - ステータス値をデザイン定義のバッジバリアントへマッピングする表示コンポーネントを用意する
  - 休憩開始・終了時刻をHH:mm形式で表示し未入力時は「未登録」や「入力待ち」バッジへ切り替える
  - レイアウト崩れやモバイル表示への影響を回避するレスポンシブ調整を施す
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ] 3.3 休憩トグル操作による表示更新を実装
  - トグル操作で適切なAPIを呼び出し成功時にホームダッシュボードのキャッシュを再取得する
  - エラー発生時に既存のトースト通知と連携させユーザーへメッセージを返す
  - ステータス遷移後に勤務バッジと休憩時刻が同期していることを即座に確認する
  - _Requirements: 1.3, 1.4, 2.2, 2.3, 2.4_

- [ ] 4. 勤怠履歴に休憩・残業の可視化を加える
  - 履歴テーブルに新列を追加し未登録時の表示ルールを統一する
  - 月次サマリと一覧の残業値を合わせて可視化する
  - ホームとのデータ整合性を継続的に確認する導線を準備する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 4.1 履歴テーブルの列とバッジ表示を拡張
  - 休憩開始・終了・残業列を追加し並び順と列幅を調整する
  - 未登録値を「未登録」バッジで統一し表示条件をユーティリティ化する
  - ソートやフィルタとの連携を確認し既存操作性が落ちないようにする
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 4.2 月次サマリと累積計算をアップデート
  - 月次サマリカードに残業合計を追加し表示フォーマットを定義する
  - 日次の残業分数を集計して休日や0時間の場合の表示を調整する
  - キャッシュの無効化と再計算がホームと矛盾しないことを検証する
  - _Requirements: 3.3, 3.4_

- [ ] 5. 品質検証と回帰防止を実施
  - 追加ロジックのユニットテストとビジネス分岐のエッジケースを網羅する
  - APIとUIの統合ポイントで期待通りのデータが流れることを確認する
  - 最終的な利用体験をE2Eで担保し回帰リスクを低減する
  - _Requirements: [全要件の検証]_

- [ ] 5.1 バックエンドユニットテストで業務分岐を網羅
  - ステータス導出・残業計算の正常系と境界値をテストケース化する
  - トグルAPIの状態遷移とエラーハンドリングを単体レベルで検証する
  - NULLデータや連続操作時の例外パスが保護されているか確認する
  - _Requirements: [全要件の検証]_

- [ ] 5.2 コントローラーとマッパーの統合テストを整備
  - `/api/home/overview`拡張レスポンスに新フィールドが含まれることをMockMvcで確認する
  - `/api/stamp-history`のレスポンスと残業計算の整合をTestcontainersで検証する
  - 休憩トグル後の再取得が最新データを返すことをAPIテストで確認する
  - _Requirements: [全要件の検証]_

- [ ] 5.3 フロントエンドのユニット・コンポーネントテストを追加
  - attendance情報の取得フックが状態遷移に追従することをテストで確認する
  - ステータスバッジと休憩表示コンポーネントの分岐をスナップショット・ロジックで検証する
  - 履歴テーブル拡張がフィルタ・ソートと共存できることをユニットテストする
  - _Requirements: [全要件の検証]_

- [ ] 5.4 E2Eテストでホームと履歴の体験を検証
  - 既存のPlaywrightシナリオに休憩ステータスと時刻表示の確認手順を追加する
  - トグル操作で「休憩中」「勤務中」が切り替わりUIが再描画されることを実ブラウザで検証する
  - 勤怠履歴画面で休憩列と残業列が期待通りに表示されるシナリオを追加する
  - _Requirements: [全要件の検証]_
