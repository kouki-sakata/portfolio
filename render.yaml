services:
  # Spring Boot API Service
  - type: web
    name: teamdev-api
    runtime: docker
    plan: starter  # または standard
    region: singapore  # アジア太平洋地域
    branch: main
    dockerfilePath: ./Dockerfile
    dockerContext: .
    numInstances: 1
    healthCheckPath: /actuator/health
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
      - key: APP_NAME
        value: TeamDevelop-API
      - key: SERVER_PORT
        value: 8080
      - key: DB_HOST
        fromDatabase:
          name: teamdev-postgres
          property: host
      - key: DB_PORT
        fromDatabase:
          name: teamdev-postgres
          property: port
      - key: DB_NAME
        fromDatabase:
          name: teamdev-postgres
          property: database
      - key: DB_USERNAME
        fromDatabase:
          name: teamdev-postgres
          property: user
      - key: DB_PASSWORD
        fromDatabase:
          name: teamdev-postgres
          property: password
      - key: JWT_SECRET
        generateValue: true
      - key: ENCRYPTION_KEY
        generateValue: true
      - key: APP_ENVIRONMENT
        value: production
      - key: APP_STARTUP_SECURITY_STRICT
        value: true
      - key: SERVER_SERVLET_SESSION_COOKIE_SAME_SITE
        value: none
      - key: SERVER_SERVLET_SESSION_COOKIE_SECURE
        value: true
      - key: SPRING_WEB_CORS_ALLOWED_ORIGINS
        value: https://teamdev.vercel.app
      - key: SPRING_JACKSON_TIME_ZONE
        value: Asia/Tokyo
      - key: LOG_LEVEL_ROOT
        value: WARN
      - key: LOG_LEVEL_APP
        value: INFO
      - key: LOG_FILE
        value: /tmp/teamdev.log
      - key: MANAGEMENT_PORT
        value: 8081
    buildFilter:
      paths:
        - src/**
        - frontend/**
        - build.gradle
        - gradlew
        - gradle/**
        - Dockerfile
      ignoredPaths:
        - README.md
        - docs/**
        - "*.md"

# PostgreSQL Database
databases:
  - name: teamdev-postgres
    plan: starter
    region: singapore
    databaseName: teamdev_db
    user: teamdev_user
    ipAllowList: []
    postgresMajorVersion: "16"
