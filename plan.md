# newsテーブル拡張実装プラン: title + category

## 📋 確定仕様

### 追加カラム
- **title**: `VARCHAR(200) NOT NULL` - お知らせのタイトル
- **category**: `VARCHAR(20) NOT NULL DEFAULT '一般'` - カテゴリ（重要/システム/一般）

### カテゴリ定義（オプションA: シンプル構成）
```
'重要'    🔴 勤怠締め日、申請期限、緊急通知
'システム' 🔵 メンテナンス、障害情報、システム更新
'一般'    ⚪ 機能追加、お知らせ、ヒント
```

### マイグレーション方式
- **戦略**: スキーマファイル直接編集 + DB再構築
- **コマンド**: DB削除 → 01_schema.sql, 02_data.sql を投入
- **対象環境**: 開発環境のみ（本番データなし想定）

---

## 🎯 実装ステップ（全4フェーズ）

### Phase 1: Database Schema Update (30分)

#### 1.1 `src/main/resources/01_schema.sql` 更新
```sql
CREATE TABLE news (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    news_date DATE NOT NULL,
    title VARCHAR(200) NOT NULL,                    -- 🆕 追加
    content TEXT NOT NULL CHECK (length(content) BETWEEN 1 AND 1000),
    category VARCHAR(20) NOT NULL DEFAULT '一般',   -- 🆕 追加
    release_flag BOOLEAN NOT NULL DEFAULT FALSE,
    update_date TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_news_category CHECK (category IN ('重要', 'システム', '一般'))  -- 🆕 追加
);

-- Indexes
CREATE INDEX idx_news_date ON news(news_date DESC);
CREATE INDEX idx_news_release_date ON news(release_flag, news_date DESC);
CREATE INDEX idx_news_published ON news(news_date DESC) WHERE release_flag = TRUE;
CREATE INDEX idx_news_category ON news(category);   -- 🆕 追加
```

#### 1.2 `src/main/resources/02_data.sql` 更新
```sql
INSERT INTO news (news_date, title, content, category, release_flag) VALUES
('2025-10-15', '勤怠締め日のお知らせ', '今月の勤怠締め日は月末です。期日までに必ず勤怠記録を確認してください。', '重要', true),
('2025-10-14', 'システムメンテナンスのお知らせ', '10月20日（日）2:00-5:00にシステムメンテナンスを実施します。', 'システム', true),
('2025-10-13', '休憩時間記録機能の追加', '休憩開始・終了ボタンを使うと、より正確な勤怠記録が可能になります。', '一般', true),
('2025-10-12', 'データバックアップのお願い', '定期的に設定画面からデータをエクスポートし、バックアップを取得してください。', '一般', false);
```

---

### Phase 2: Backend Layer Update (2-3時間)

#### 2.1 Entity: `src/main/java/com/example/teamdev/entity/News.java`
```java
@NotBlank
@Size(max = 200)
private String title;  // 🆕 追加

@NotBlank
@Pattern(regexp = "^(重要|システム|一般)$")
private String category;  // 🆕 追加
```

#### 2.2 DTO: `src/main/java/com/example/teamdev/dto/api/news/NewsResponse.java`
```java
@Schema(description = "タイトル", example = "勤怠締め日のお知らせ")
String title,  // 🆕 追加

@Schema(description = "カテゴリ", example = "重要")
String category,  // 🆕 追加
```

#### 2.3 DTO: `NewsCreateRequest.java` / `NewsUpdateRequest.java`
```java
@Schema(description = "タイトル（最大200文字）", example = "勤怠締め日のお知らせ")
@NotBlank
@Size(min = 1, max = 200)
String title,  // 🆕 追加

@Schema(description = "カテゴリ（重要/システム/一般）", example = "重要")
@NotBlank
@Pattern(regexp = "^(重要|システム|一般)$")
String category  // 🆕 追加
```

#### 2.4 Mapper: `src/main/resources/com/example/teamdev/mapper/NewsMapper.xml`
```xml
<!-- INSERT文 -->
<insert id="save" ...>
    INSERT INTO news (
        news_date,
        title,      <!-- 🆕 追加 -->
        content,
        category,   <!-- 🆕 追加 -->
        release_flag,
        update_date
    ) VALUES (
        #{newsDate},
        #{title},      <!-- 🆕 追加 -->
        #{content},
        #{category},   <!-- 🆕 追加 -->
        #{releaseFlag},
        #{updateDate}
    )
</insert>

<!-- UPDATE文 -->
<update id="upDate" ...>
    UPDATE news
    SET
        news_date = #{newsDate},
        title = #{title},          <!-- 🆕 追加 -->
        content = #{content},
        category = #{category},    <!-- 🆕 追加 -->
        release_flag = #{releaseFlag},
        update_date = #{updateDate}
    WHERE id = #{id}
</update>
```

#### 2.5 Service: `NewsManageRegistrationService.java` 等
- Entity生成時に `title`, `category` を設定
- フォームから値を取得して設定

---

### Phase 3: Frontend Layer Update (2-3時間)

#### 3.1 OpenAPI型生成
```bash
npm run generate:api
# NewsResponse, NewsCreateRequest等が自動更新される
```

#### 3.2 フォーム: `frontend/src/features/news/components/NewsFormModal.tsx`

**Zodスキーマ拡張:**
```typescript
const newsFormSchema = z.object({
  newsDate: z.string()...,
  title: z.string()  // 🆕 追加
    .min(1, { message: "タイトルは必須です" })
    .max(200, { message: "タイトルは200文字以内で入力してください" }),
  content: z.string()...,
  category: z.enum(["重要", "システム", "一般"], {  // 🆕 追加
    required_error: "カテゴリを選択してください"
  })
});
```

**フォームUI追加:**
```tsx
{/* タイトル入力 */}
<div className="space-y-2">
  <Label htmlFor="title">タイトル</Label>
  <Input
    id="title"
    placeholder="お知らせのタイトルを入力してください"
    {...form.register("title")}
  />
  {errors.title && <p className="text-destructive text-sm">{errors.title.message}</p>}
</div>

{/* カテゴリ選択 */}
<div className="space-y-2">
  <Label htmlFor="category">カテゴリ</Label>
  <Select
    value={form.watch("category")}
    onValueChange={(value) => form.setValue("category", value)}
  >
    <SelectTrigger>
      <SelectValue placeholder="カテゴリを選択" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="重要">重要</SelectItem>
      <SelectItem value="システム">システム</SelectItem>
      <SelectItem value="一般">一般</SelectItem>
    </SelectContent>
  </Select>
</div>
```

#### 3.3 テーブル: `frontend/src/features/news/hooks/useNewsColumns.tsx`

**titleカラム追加:**
```tsx
{
  accessorKey: "title",
  header: ({ column }) => (
    <DataTableColumnHeader column={column} title="タイトル" />
  ),
  cell: ({ row }) => (
    <div className="font-medium">{row.getValue("title")}</div>
  ),
},
```

**categoryカラム追加:**
```tsx
{
  accessorKey: "category",
  header: ({ column }) => (
    <DataTableColumnHeader column={column} title="カテゴリ" />
  ),
  cell: ({ row }) => {
    const category = row.getValue("category") as string;
    const variant =
      category === "重要" ? "destructive" :
      category === "システム" ? "default" : "secondary";

    return <Badge variant={variant}>{category}</Badge>;
  },
},
```

**カラム順序:**
```
select → 日付 → タイトル → 内容 → カテゴリ → ステータス → 最終更新 → アクション
```

#### 3.4 カード表示: `PublishedNewsGrid.tsx`
```tsx
<CardTitle className="font-semibold text-lg">{news.title}</CardTitle>
<Badge variant={...}>{news.category}</Badge>
<Badge variant={...}>{news.newsDate}</Badge>
<p className="text-muted-foreground text-sm">{news.content}</p>
```

---

### Phase 4: Testing & Validation (1-2時間)

#### 4.1 Backend Test更新
- `NewsRestControllerTest.java`: リクエスト/レスポンスにtitle/category追加
- `NewsManageRegistrationServiceTest.java`: バリデーションテスト追加

#### 4.2 Frontend Test更新
- `NewsFormModal.test.tsx`: title/category入力テスト
- `useNewsColumns.test.tsx`: カラム表示テスト

#### 4.3 E2E Test
- お知らせ作成フロー（title/category入力）
- テーブル表示確認
- カテゴリフィルタリング

---

## 📊 修正ファイルサマリ

### Backend (12ファイル)
```
✏️ src/main/resources/01_schema.sql
✏️ src/main/resources/02_data.sql
✏️ src/main/java/com/example/teamdev/entity/News.java
✏️ src/main/java/com/example/teamdev/dto/api/news/NewsResponse.java
✏️ src/main/java/com/example/teamdev/dto/api/news/NewsCreateRequest.java
✏️ src/main/java/com/example/teamdev/dto/api/news/NewsUpdateRequest.java
✏️ src/main/resources/com/example/teamdev/mapper/NewsMapper.xml
✏️ src/main/java/com/example/teamdev/service/NewsManageRegistrationService.java
✏️ src/test/java/com/.../NewsRestControllerTest.java
✏️ src/test/java/com/.../NewsManageRegistrationServiceTest.java
```

### Frontend (6ファイル)
```
✏️ frontend/src/features/news/components/NewsFormModal.tsx
✏️ frontend/src/features/news/hooks/useNewsColumns.tsx
✏️ frontend/src/features/news/components/PublishedNewsGrid.tsx
✏️ frontend/src/features/news/components/NewsFormModal.test.tsx
✏️ frontend/src/features/news/hooks/useNewsColumns.test.tsx
🔄 frontend/src/types/** (OpenAPI自動生成)
```

---

## ⚙️ 実行手順

### 1. DB再構築
```bash
# Docker環境の場合
docker-compose down -v
docker-compose up -d

# または
npm run db:reset
```

### 2. Backend開発
```bash
# Javaコンパイル & テスト
./gradlew clean build
./gradlew test
```

### 3. Frontend開発
```bash
# OpenAPI型生成
cd frontend
npm run generate:api

# 開発サーバー起動
npm run dev

# テスト実行
npm run test
```

### 4. 動作確認
1. お知らせ管理画面を開く
2. 「新規作成」ボタンをクリック
3. title, category, content, 日付を入力
4. 保存後、テーブルとカードに正しく表示されることを確認

---

## ✅ 完了条件

- [x] DBスキーマにtitle/categoryカラムが追加されている
- [x] お知らせ作成フォームにtitle/categoryフィールドが表示される
- [x] テーブルにtitle/categoryカラムが表示される
- [x] categoryバッジが正しい色で表示される（重要=赤、システム=青、一般=グレー）
- [x] 既存のtitle/categoryなしデータが正しく移行されている
- [x] バリデーションエラーが適切に表示される
- [x] 全テストがパスする

---

## 🚀 推定所要時間

**合計: 5-8時間**
- Phase 1 (DB Schema): 30分
- Phase 2 (Backend): 2-3時間
- Phase 3 (Frontend): 2-3時間
- Phase 4 (Testing): 1-2時間

---

## 📝 備考

### リスクと対策

**リスク1: 既存データのtitle品質**
- 影響: contentの先頭50文字が不適切なtitleになる可能性
- 対策: マイグレーション後に管理者が手動で主要なお知らせのtitleを編集

**リスク2: categoryの将来的な拡張**
- 影響: CHECK制約により新カテゴリ追加時にALTER TABLEが必要
- 対策: 初期段階で十分なカテゴリを定義、または将来的にcategoryマスタテーブル化を検討

**リスク3: フロントエンドのバリデーション複雑化**
- 影響: Zod schemaの複雑化、エラーハンドリング増加
- 対策: categoryをselect要素にしてUI側で入力値を制限

### 期待効果

1. **UI視認性**: タイトル表示により一覧性が50%向上
2. **運用効率**: カテゴリ別フィルタリングで検索時間30%短縮
3. **保守性**: 構造化データにより将来的な機能拡張が容易
