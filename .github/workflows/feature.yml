name: Feature Branch Pipeline

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'

env:
  JAVA_VERSION: '21'

jobs:
  validate:
    name: Validate Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ï¼‰

      - name: Check branch naming convention
        run: |
          BRANCH_NAME=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          echo "Checking branch name: $BRANCH_NAME"
          
          if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix)/.+ ]]; then
            echo "âŒ Branch name must start with 'feature/', 'bugfix/', or 'hotfix/'"
            exit 1
          fi
          
          if [[ ${#BRANCH_NAME} -gt 50 ]]; then
            echo "âŒ Branch name is too long (max 50 characters)"
            exit 1
          fi
          
          echo "âœ… Branch name is valid"

      - name: Check commit messages
        run: |
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          echo "Checking commit message: $COMMIT_MSG"
          
          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹: feat: æ–°æ©Ÿèƒ½, fix: ãƒã‚°ä¿®æ­£ï¼‰
          if [[ ! "$COMMIT_MSG" =~ ^(feat|fix|docs|style|refactor|test|chore):.+ ]]; then
            echo "âš ï¸ Commit message should follow conventional format: type: description"
            echo "   Examples: feat: add new feature, fix: resolve bug"
          fi

      - name: Check for large files
        run: |
          # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸Šï¼‰
          LARGE_FILES=$(find . -type f -size +5M -not -path "./.git/*" -not -path "./build/*" -not -path "./.gradle/*")
          
          if [ -n "$LARGE_FILES" ]; then
            echo "âŒ Large files detected (>5MB):"
            echo "$LARGE_FILES"
            echo "Consider using Git LFS or reducing file size"
            exit 1
          fi
          
          echo "âœ… No large files detected"

  quick-test:
    name: Quick Tests
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Run frontend lint (Biome)
        working-directory: frontend
        run: npm run biome:ci

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Compile code
        run: ./gradlew compileJava compileTestJava

      - name: Run unit tests (fast)
        run: ./gradlew test --parallel --max-workers=4
        env:
          SPRING_PROFILES_ACTIVE: test
          LOG_LEVEL_ROOT: ERROR

      - name: Run API tests (tagged)
        run: ./gradlew apiTest --no-daemon
        env:
          SPRING_PROFILES_ACTIVE: test

      - name: Generate coverage reports
        run: ./gradlew jacocoTestReport jacocoApiTestReport --no-daemon

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: feature-coverage-reports
          path: |
            build/reports/jacoco/test/html/
            build/reports/jacoco/jacocoApiTestReport/html/

      - name: Check code style
        run: ./gradlew checkstyleMain checkstyleTest || true

      - name: Upload quick test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quick-test-results
          path: |
            build/test-results/test/
            build/test-results/apiTest/
            build/reports/tests/test/
            build/reports/tests/apiTest/
            build/reports/checkstyle/

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run security scan (quick)
        run: |
          # è»½é‡ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          ./gradlew dependencyCheckAnalyze --info || true

      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for hardcoded credentials
        run: |
          # ç°¡å˜ãªãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒãƒ³ã‚°ã§ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯
          echo "Checking for potential hardcoded secrets..."
          
          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
          )
          
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(grep -r -i -E "$pattern" src/ || true)
            if [ -n "$MATCHES" ]; then
              echo "âš ï¸ Potential hardcoded secret found:"
              echo "$MATCHES"
            fi
          done

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    needs: [ validate, quick-test ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Analyze code complexity
        run: |
          echo "Analyzing code complexity..."
          # ã‚·ãƒ³ãƒ—ãƒ«ãªè¤‡é›‘åº¦åˆ†æž
          find src/main/java -name "*.java" | xargs wc -l | sort -n | tail -10 > complexity-report.txt
          echo "Top 10 largest files:"
          cat complexity-report.txt

      - name: Check TODOs and FIXMEs
        run: |
          echo "Checking for TODOs and FIXMEs..."
          TODO_COUNT=$(grep -r -i "TODO\|FIXME\|XXX\|HACK" src/ | wc -l || echo "0")
          echo "Found $TODO_COUNT TODO/FIXME comments"
          
          if [ "$TODO_COUNT" -gt 20 ]; then
            echo "âš ï¸ High number of TODO/FIXME comments ($TODO_COUNT)"
            echo "Consider addressing some before merging"
          fi

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: code-analysis
          path: complexity-report.txt

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [ quick-test, security-check ]
    if: contains(github.event.head_commit.message, '[full-test]') || github.event_name == 'pull_request'

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: teamdev_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d teamdev_test_db"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Wait for PostgreSQL
        env:
          PGPASSWORD: test_password
        run: |
          for i in {1..30}; do
            if pg_isready -h 127.0.0.1 -p 5432 -d teamdev_test_db -U test_user; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Set up test database
        env:
          PGPASSWORD: test_password
        run: |
          psql -h 127.0.0.1 -p 5432 -U test_user -d teamdev_test_db -f src/main/resources/01_schema.sql
          psql -h 127.0.0.1 -p 5432 -U test_user -d teamdev_test_db -f src/main/resources/02_data.sql

      - name: Run integration tests
        run: ./gradlew test integrationTest || true
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_NAME: teamdev_test_db
          DB_USERNAME: test_user
          DB_PASSWORD: test_password
          SPRING_PROFILES_ACTIVE: test

      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            build/test-results/
            build/reports/tests/

  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: [ quick-test ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build application
        run: ./gradlew build -x test

      - name: Test Docker build
        run: |
          docker build -t teamdev:feature-test .
          echo "Docker image built successfully"

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [ validate, quick-test, security-check, code-analysis, build-test ]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Feature Branch Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Validation: ${{ needs.validate.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quick Tests: ${{ needs.quick-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security Check: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Analysis: ${{ needs.code-analysis.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build Test: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.validate.result }}" == "success" && "${{ needs.quick-test.result }}" == "success" && "${{ needs.security-check.result }}" == "success" && "${{ needs.build-test.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All checks passed!** This branch is ready for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed.** Please review the results above." >> $GITHUB_STEP_SUMMARY
          fi
